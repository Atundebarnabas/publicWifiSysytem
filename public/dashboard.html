<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Wifi</title>
  <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>
<body>
  <!-- <h1>JESUS IS LORD FOREVER!!!!; AMEN</h1> -->

  <main class="container">
    <div class="welcome_txt">
      <span>Hello There! üëãüèΩ</span>
    </div>
    <div class="wrapped_cont">
      <ul class="one deviceInfo" style="display: none;">
        <div class="title_sec">
          <div class="iconvg">
            <!-- Title: ‚ÄúDevices 1 SVG Vector‚Äù
                Author: ‚ÄúIconsax‚Äú‚Äî https://www.svgrepo.com/author/Iconsax/
                Source: ‚Äúsvgrepo.com‚Äú‚Äî https://www.svgrepo.com/
                License: ‚ÄúMIT License‚Äù‚Äî https://www.svgrepo.com/page/licensing#MIT 
						-->
            <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.7199 9.69002C17.7799 11.75 17.7799 15.08 15.7199 17.13C13.6599 19.19 10.3299 19.19 8.27986 17.13C6.21986 15.07 6.21986 11.74 8.27986 9.69002C10.3299 7.63002 13.6699 7.63002 15.7199 9.69002Z" stroke-width="1.5093" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M11.9999 13.4099L10.4099 14.9999" stroke-width="1.5093" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M19.0701 6.33997C19.2201 6.48997 19.2201 6.73997 19.0701 6.89997C18.9201 7.04997 18.6701 7.04997 18.5101 6.89997C18.3501 6.74997 18.3601 6.49997 18.5101 6.33997C18.6601 6.17997 18.9201 6.17997 19.0701 6.33997Z" stroke-miterlimit="10"/>
              <path d="M19.0701 6.33997C19.2201 6.48997 19.2201 6.73997 19.0701 6.89997C18.9201 7.04997 18.6701 7.04997 18.5101 6.89997C18.3501 6.74997 18.3601 6.49997 18.5101 6.33997C18.6601 6.17997 18.9201 6.17997 19.0701 6.33997Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5.48988 19.92C5.63988 20.07 5.63988 20.32 5.48988 20.48C5.33988 20.64 5.08988 20.63 4.92988 20.48C4.77988 20.33 4.77988 20.08 4.92988 19.92C5.07988 19.76 5.33988 19.76 5.48988 19.92Z" stroke-miterlimit="10"/>
              <path d="M5.48988 19.92C5.63988 20.07 5.63988 20.32 5.48988 20.48C5.33988 20.64 5.08988 20.63 4.92988 20.48C4.77988 20.33 4.77988 20.08 4.92988 19.92C5.07988 19.76 5.33988 19.76 5.48988 19.92Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21.8799 13.13C22.0299 13.28 22.0299 13.53 21.8799 13.69C21.7299 13.84 21.4799 13.84 21.3199 13.69C21.1599 13.54 21.1699 13.29 21.3199 13.13C21.4699 12.97 21.7299 12.97 21.8799 13.13Z" stroke-miterlimit="10"/>
              <path d="M21.8799 13.13C22.0299 13.28 22.0299 13.53 21.8799 13.69C21.7299 13.84 21.4799 13.84 21.3199 13.69C21.1599 13.54 21.1699 13.29 21.3199 13.13C21.4699 12.97 21.7299 12.97 21.8799 13.13Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M2.67009 13.13C2.82009 13.28 2.82009 13.53 2.67009 13.69C2.52009 13.85 2.27006 13.84 2.11006 13.69C1.96006 13.54 1.96006 13.29 2.11006 13.13C2.27006 12.97 2.52009 12.97 2.67009 13.13Z" stroke-miterlimit="10"/>
              <path d="M2.67009 13.13C2.82009 13.28 2.82009 13.53 2.67009 13.69C2.52009 13.85 2.27006 13.84 2.11006 13.69C1.96006 13.54 1.96006 13.29 2.11006 13.13C2.27006 12.97 2.52009 12.97 2.67009 13.13Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M19.0701 19.92C19.2201 20.07 19.2201 20.32 19.0701 20.48C18.9201 20.63 18.6701 20.63 18.5101 20.48C18.3501 20.33 18.3601 20.08 18.5101 19.92C18.6701 19.76 18.9201 19.76 19.0701 19.92Z" stroke-miterlimit="10"/>
              <path d="M19.0701 19.92C19.2201 20.07 19.2201 20.32 19.0701 20.48C18.9201 20.63 18.6701 20.63 18.5101 20.48C18.3501 20.33 18.3601 20.08 18.5101 19.92C18.6701 19.76 18.9201 19.76 19.0701 19.92Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5.48988 6.33997C5.63988 6.48997 5.63988 6.73997 5.48988 6.89997C5.33988 7.05997 5.08988 7.04997 4.92988 6.89997C4.77988 6.74997 4.77988 6.49997 4.92988 6.33997C5.07988 6.17997 5.33988 6.17997 5.48988 6.33997Z" stroke-miterlimit="10"/>
              <path d="M5.48988 6.33997C5.63988 6.48997 5.63988 6.73997 5.48988 6.89997C5.33988 7.05997 5.08988 7.04997 4.92988 6.89997C4.77988 6.74997 4.77988 6.49997 4.92988 6.33997C5.07988 6.17997 5.33988 6.17997 5.48988 6.33997Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12.28 3.52009C12.43 3.67009 12.43 3.92009 12.28 4.08009C12.13 4.24009 11.88 4.23009 11.72 4.08009C11.56 3.93009 11.57 3.68009 11.72 3.52009C11.87 3.36009 12.13 3.37009 12.28 3.52009Z" stroke-miterlimit="10"/>
              <path d="M12.28 3.52009C12.43 3.67009 12.43 3.92009 12.28 4.08009C12.13 4.24009 11.88 4.23009 11.72 4.08009C11.56 3.93009 11.57 3.68009 11.72 3.52009C11.87 3.36009 12.13 3.37009 12.28 3.52009Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="txt">Device Information</div>
        </div>
        <li>
          <div class="left">
            <div class="icon">
              <!-- Title: ‚ÄúLocation SVG Vector‚Äù
                  Author: ‚ÄúIconsax‚Äú‚Äî https://www.svgrepo.com/author/Iconsax/
                  Source: ‚Äúsvgrepo.com‚Äú‚Äî https://www.svgrepo.com/
                  License: ‚ÄúMIT License‚Äù‚Äî https://www.svgrepo.com/page/licensing#MIT 
              -->
              <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 13.4299C13.7231 13.4299 15.12 12.0331 15.12 10.3099C15.12 8.58681 13.7231 7.18994 12 7.18994C10.2769 7.18994 8.88 8.58681 8.88 10.3099C8.88 12.0331 10.2769 13.4299 12 13.4299Z" />
                <path d="M3.62001 8.49C5.59001 -0.169998 18.42 -0.159997 20.38 8.5C21.53 13.58 18.37 17.88 15.6 20.54C13.59 22.48 10.41 22.48 8.39001 20.54C5.63001 17.88 2.47001 13.57 3.62001 8.49Z"/>
              </svg>
            </div>
            <div class="title">Mac Address: </div>
          </div>
          <div class="right">
            <span class="listcontent" id="mac_address"></span>
          </div>
        </li>
        <li>
          <div class="left">
            <div class="icon">
              <!-- Title: ‚ÄúCode 1 SVG Vector‚Äù
                  Author: ‚ÄúIconsax‚Äú‚Äî https://www.svgrepo.com/author/Iconsax/
                  Source: ‚Äúsvgrepo.com‚Äú‚Äî https://www.svgrepo.com/
                  License: ‚ÄúMIT License‚Äù‚Äî https://www.svgrepo.com/page/licensing#MIT 
              -->
              <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
              <svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6.89001 9C7.87001 9.49 8.71001 10.23 9.32001 11.15C9.67001 11.67 9.67001 12.34 9.32001 12.86C8.71001 13.77 7.87001 14.51 6.89001 15" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M13 15H17" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              </svg>
            </div>
            <div class="title">IP Address: </div>
          </div>
          <div class="right">
            <span class="listcontent" id="ip_address"></span>
          </div>
        </li>
      </ul>
      <ul class="one deviceInfo">
        <div class="title_sec">
          <div class="iconvg">
            <!-- Title: ‚ÄúUser SVG Vector‚Äù
                Author: ‚ÄúIconsax‚Äú‚Äî https://www.svgrepo.com/author/Iconsax/
                Source: ‚Äúsvgrepo.com‚Äú‚Äî https://www.svgrepo.com/
                License: ‚ÄúMIT License‚Äù‚Äî https://www.svgrepo.com/page/licensing#MIT 
						-->
            <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M20.5899 22C20.5899 18.13 16.7399 15 11.9999 15C7.25991 15 3.40991 18.13 3.40991 22" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="txt">Account Information</div>
        </div>
        <li>
          <div class="left">
            <div class="icon">
              <!-- Title: ‚ÄúHashtag 1 SVG Vector‚Äù
										Author: ‚ÄúIconsax‚Äú‚Äî https://www.svgrepo.com/author/Iconsax/
										Source: ‚Äúsvgrepo.com‚Äú‚Äî https://www.svgrepo.com/
										License: ‚ÄúMIT License‚Äù‚Äî https://www.svgrepo.com/page/licensing#MIT 
						  -->
              <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 3L8 21" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 3L14 21" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3.5 9H21.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2.5 15H20.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="title">Login ID: </div>
          </div>
          <div class="right">
            <span class="listcontent" id="login_id"></span>
          </div>
        </li>
        <li>
          <div class="left">
            <div class="icon">
              <!-- Title: ‚ÄúKey SVG Vector‚Äù
										Author: ‚ÄúIconsax‚Äú‚Äî https://www.svgrepo.com/author/Iconsax/
										Source: ‚Äúsvgrepo.com‚Äú‚Äî https://www.svgrepo.com/
										License: ‚ÄúMIT License‚Äù‚Äî https://www.svgrepo.com/page/licensing#MIT 
						  -->
              <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.79 14.9299C17.73 16.9799 14.78 17.6099 12.19 16.7999L7.48002 21.4999C7.14002 21.8499 6.47002 22.0599 5.99002 21.9899L3.81002 21.6899C3.09002 21.5899 2.42002 20.9099 2.31002 20.1899L2.01002 18.0099C1.94002 17.5299 2.17002 16.8599 2.50002 16.5199L7.20002 11.8199C6.40002 9.21995 7.02002 6.26995 9.08002 4.21995C12.03 1.26995 16.82 1.26995 19.78 4.21995C22.74 7.16995 22.74 11.9799 19.79 14.9299Z" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6.89001 17.49L9.19001 19.79" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14.5 11C15.3284 11 16 10.3284 16 9.5C16 8.67157 15.3284 8 14.5 8C13.6716 8 13 8.67157 13 9.5C13 10.3284 13.6716 11 14.5 11Z" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="title">PassKey: </div>
          </div>
          <div class="right">
            <span class="listcontent" id="pass_key"></span>
          </div>
        </li>
      </ul>
    </div>
    <div class="lg_out_btn">
      <button onclick="handleLogout()">
        <div class="icon">
            <!-- Title: ‚ÄúLogout SVG Vector‚Äù
                  Author: ‚ÄúIconsax‚Äú‚Äî https://www.svgrepo.com/author/Iconsax/
                  Source: ‚Äúsvgrepo.com‚Äú‚Äî https://www.svgrepo.com/
                  License: ‚ÄúMIT License‚Äù‚Äî https://www.svgrepo.com/page/licensing#MIT 
            -->
            <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8.90002 7.55999C9.21002 3.95999 11.06 2.48999 15.11 2.48999H15.24C19.71 2.48999 21.5 4.27999 21.5 8.74999V15.27C21.5 19.74 19.71 21.53 15.24 21.53H15.11C11.09 21.53 9.24002 20.08 8.91002 16.54" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M15 12H3.62" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5.85 8.6499L2.5 11.9999L5.85 15.3499" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="txt">Log Out</div>
      </button>
    </div>
  </main>

  <script>
      async function fetchServerInfo() {
        try {
          const response = await fetch('/api/server-info'); // Relative URL to your server endpoint
          if (!response.ok) {
            throw new Error('Failed to fetch server info');
          }
          const data = await response.json();
          const { serverIpAddress, serverPort } = data;
          
          // Use server IP address and port as needed
          console.log('Server IP Address:', serverIpAddress);
          console.log('Server Port:', serverPort);
          
          return { serverIpAddress, serverPort };
        } catch (error) {
          console.error('Error fetching server info', error);
          return null;
        }
      }

      async function fetchMacAddresses() {
        try {
          const {serverIpAddress, serverPort} = await fetchServerInfo(); // Get the ip address and port number dynamically
          const response = await fetch(`http://${serverIpAddress}:${serverPort}/api/mac-addresses`); // Relative URL
          const data = await response.json();
          const { macAddresses, clientIp } = data;

          let clientMacAddress = 'Not found';
          let clientIpAddress = clientIp;

          macAddresses.forEach(({ ip, mac }) => {
            // const li = document.createElement('li');
            // li.textContent = `${ip} - ${mac}`;
            // macList.appendChild(li);

            if (ip === clientIp) {
              clientMacAddress = mac.replace(/[--]/g, ':');
            }
          });

          console.log(clientMacAddress , " ", clientIpAddress);
          return {clientMacAddress, clientIpAddress};

        } catch (error) {
          console.error('Error fetching MAC addresses', error);
          return {clientMacAddress: 'Error', clientIpAddress: 'Error'};
        }
    }

    async function fetchAccountDetails()
    {
      try
      {
        const response = await fetch('/accountDetails');

        // Check if response was redirected
        if(response.redirected)
        {
          // Handle redirection
          console.log('Response was redirected, redirecting to:', response.url);
          window.location.href = response.url;
          return; // Exit the function after redirecting
        }


        if(!response.ok)
        {
          throw new Error('Network response was not okay');
        }
        const accountDetails = await response.json();

        // Display account details
        let loginid = document.getElementById('login_id');
        let passkey = document.getElementById('pass_key');
        let macaddress = document.getElementById('mac_address');
        let ipaddress = document.getElementById('ip_address');

        loginid.textContent = accountDetails.loginId;
        passkey.textContent = accountDetails.passkey;


        const {clientMacAddress, clientIpAddress} = await fetchMacAddresses();
        // Update account if mac or ip address is empty
        if(accountDetails.mac_address === '' || accountDetails.ip_address === '')
        {
          await updateMacandIpAddress(accountDetails.loginId, clientMacAddress, clientIpAddress);
        }
        macaddress.textContent = (accountDetails.mac_address === '') ? clientMacAddress : accountDetails.mac_address;
        
        ipaddress.textContent = (accountDetails.ip_address === '') ? clientIpAddress : accountDetails.ip_address;
      }
      catch (error)
      {
        console.error('Fecth account details error: ', error);
      }
    }

    async function updateMacandIpAddress(loginId, clientMacAddress, clientIpAddress)
    {
      try
      {
        const response = await fetch('/updateMacandIpAddress', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ loginId, clientMacAddress, clientIpAddress })
        });
        if(!response.ok)
        {
          throw new Error('Failed to update MAC address and IP address');
        }
        const data = await response.json();
        console.log('Update success: ', data);
      }
      catch (error)
      {
        console.error('Update MAC address and IP address error: ', error);
      }
    }

    // Call the fetchAccountDetails function here
    document.addEventListener('DOMContentLoaded', fetchAccountDetails());

    function handleLogout()
    {
       // Redirect to auth page
       window.location.href = '/pw/logout';
    }
  </script>
  

</body>
</html>